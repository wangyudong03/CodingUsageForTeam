name: Deploy CodingUsageWeb

on:
  push:
    branches:
      - main
    paths:
      - 'CodingUsageWeb/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.WEB_HOST }}
          username: ${{ secrets.WEB_USERNAME }}
          key: ${{ secrets.WEB_SSH_KEY }}
          source: "CodingUsageWeb/"
          target: "/home/${{ secrets.WEB_USERNAME }}/"
          strip_components: 0
          overwrite: true
          rm: false

      - name: Install dependencies and Restart Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WEB_HOST }}
          username: ${{ secrets.WEB_USERNAME }}
          key: ${{ secrets.WEB_SSH_KEY }}
          command_timeout: 30m
          script: |
            # è®¾ç½®éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="/home/${{ secrets.WEB_USERNAME }}/CodingUsageWeb"
            
            echo "======================================"
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² CodingUsageWeb"
            echo "======================================"
            echo "éƒ¨ç½²ç›®å½•: $DEPLOY_DIR"
            echo "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            
            # è¿›å…¥éƒ¨ç½²ç›®å½•
            cd $DEPLOY_DIR
            
            # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
            chmod -R 755 $DEPLOY_DIR
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£… Node.js ä¾èµ–..."
            echo "--------------------------------------"
            npm ci --production --legacy-peer-deps
            
            if [ $? -ne 0 ]; then
              echo ""
              echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
              exit 1
            fi
            
            echo ""
            echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
            echo ""
            
            # ä½¿ç”¨ PM2 é‡å¯æœåŠ¡
            echo "ğŸ”„ ä½¿ç”¨ PM2 é‡å¯æœåŠ¡..."
            echo "--------------------------------------"
            
            # æ£€æŸ¥ PM2 æ˜¯å¦å¯ç”¨
            if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 æœªå®‰è£…æˆ–ä¸åœ¨ PATH ä¸­"
              echo "è¯·è¿è¡Œ: npm install -g pm2"
              exit 1
            fi
            
            # æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²ç»åœ¨ PM2 ä¸­
            if pm2 describe coding-usage-web > /dev/null 2>&1; then
              echo "é‡å¯ç°æœ‰æœåŠ¡..."
              pm2 restart coding-usage-web --update-env
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              sleep 3
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€
              if pm2 describe coding-usage-web | grep -q "online"; then
                echo ""
                echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ"
              else
                echo ""
                echo "âš ï¸  æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨"
                pm2 logs coding-usage-web --lines 20 --nostream
                exit 1
              fi
            else
              echo "é¦–æ¬¡å¯åŠ¨ï¼Œåˆ›å»ºæ–°æœåŠ¡..."
              pm2 start server.js --name coding-usage-web
              
              # ç­‰å¾…æœåŠ¡å¯åŠ¨
              sleep 3
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€
              if pm2 describe coding-usage-web | grep -q "online"; then
                echo ""
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
              else
                echo ""
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
                pm2 logs coding-usage-web --lines 20 --nostream
                exit 1
              fi
            fi
            
            # ä¿å­˜ PM2 é…ç½®ï¼ˆå¼€æœºè‡ªå¯ï¼‰
            pm2 save
            
            echo ""
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€"
            echo "--------------------------------------"
            pm2 list
            
            echo ""
            echo "ğŸ“ æœåŠ¡è¯¦æƒ…"
            echo "--------------------------------------"
            pm2 info coding-usage-web
            
            echo ""
            echo "ğŸ“„ æœ€è¿‘æ—¥å¿—ï¼ˆæœ€å15è¡Œï¼‰"
            echo "--------------------------------------"
            pm2 logs coding-usage-web --lines 15 --nostream
            
            echo ""
            echo "======================================"
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "======================================"
            echo "éƒ¨ç½²ç›®å½•: $DEPLOY_DIR"
            echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "ğŸ’¡ æç¤ºï¼š"
            echo "  - æŸ¥çœ‹å®æ—¶æ—¥å¿—: pm2 logs coding-usage-web"
            echo "  - æŸ¥çœ‹æœåŠ¡çŠ¶æ€: pm2 status"
            echo "  - é‡å¯æœåŠ¡: pm2 restart coding-usage-web"
            echo "  - åœæ­¢æœåŠ¡: pm2 stop coding-usage-web"
            echo "======================================"
