<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <%- include('partials/head', { pageTitle: 'My Stats - Coding Usage' }) %>
</head>

<body>
  <div class="container">
    <%- include('partials/nav', { showMyStatsLink: true }) %>

      <div class="page-header">
        <h1 class="page-title">My Stats</h1>
        <p class="page-desc">View usage statistics for your bound API Keys</p>
      </div>

      <% if (!hasBoundKeys) { %>
        <div class="no-keys-message">
          <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="#57606a" stroke-width="1.5"
            style="margin-bottom: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
          </svg>
          <h3>No API Keys Bound</h3>
          <p>Bind your Client API Key to view your usage statistics. You can find your API Key in Cursor Settings →
            Extensions → Cursor Usage.</p>
          <button type="button" class="btn-primary" id="bindKeyBtnEmpty">
            <svg class="octicon" viewBox="0 0 16 16" width="16" height="16">
              <path
                d="M6.5 5.5a4 4 0 0 1 7.43 2.11.75.75 0 0 0 1.49-.16 5.5 5.5 0 1 0-10.4 3.38l-.08.08-1.63 1.63A1.75 1.75 0 0 0 3 13.75V15h1.25a1.75 1.75 0 0 0 1.24-.51l.52-.52h1.5c.69 0 1.25-.56 1.25-1.25v-.25h.75c.69 0 1.25-.56 1.25-1.25V10h1.01a.75.75 0 0 0 .53-.22l.09-.09.08-.04A4 4 0 0 0 6.5 5.5zM9 5.5a1 1 0 1 1 2 0 1 1 0 0 1-2 0z">
              </path>
            </svg>
            Bind API Key
          </button>
        </div>
        <% } else { %>
          <!-- Bound API Keys with Statistics -->
          <div class="section">
            <h2 style="margin-bottom: 16px;">Bound API Keys (<%= keys.length %>)</h2>

            <% keys.forEach(k=> { %>
              <% if (k.notFound) { %>
                <!-- API Key 不存在于数据库中 -->
                <div class="key-section" style="border-color: #d1242f;">
                  <div class="key-card">
                    <div class="key-info">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 16 16" width="20" height="20" fill="#d1242f">
                          <path
                            d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z" />
                        </svg>
                        <span class="key-value" style="color: #d1242f;">
                          <%= k.api_key_short %>
                        </span>
                      </div>
                      <span class="key-meta" style="color: #d1242f;">
                        This API Key is not found in the database. It may have been deleted or never synced.
                      </span>
                    </div>
                    <div class="key-actions">
                      <button type="button" class="unbind-btn" data-key="<%= k.api_key %>">Unbind</button>
                    </div>
                  </div>
                </div>
                <% } else { %>
                  <div class="key-section">
                    <!-- Key Header -->
                    <div class="key-card">
                      <div class="key-info">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <% if (k.app_logo) { %>
                            <img src="<%= k.app_logo %>" alt="<%= k.app_name %>"
                              style="width: 20px; height: 20px; border-radius: 4px;" />
                            <% } %>
                              <span class="key-value">
                                <%= k.email || k.api_key.substring(0, 16) + '...' %>
                              </span>
                        </div>
                        <span class="key-meta">
                          API Key: <%= k.api_key.substring(0, 8) %>... |
                            <% if (k.app_name) { %>App: <%= k.app_name %> | <% } %>
                                  Created: <%= new Date(k.created_at).toLocaleDateString() %>
                                    <% if (k.online) { %>| <span style="color: #2da44e;">● Online</span>
                                      <% } %>
                        </span>
                      </div>
                      <div class="key-actions">
                        <button type="button" class="toggle-public <%= k.is_public ? 'public' : '' %>"
                          data-key="<%= k.api_key %>">
                          <svg class="octicon" viewBox="0 0 16 16" width="14" height="14">
                            <% if (k.is_public) { %>
                              <path
                                d="M8 2c1.981 0 3.671.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.45.678-1.367 1.932-2.637 3.023C11.67 13.008 9.981 14 8 14c-1.981 0-3.671-.992-4.933-2.078C1.797 10.831.88 9.577.43 8.899a1.62 1.62 0 0 1 0-1.798c.45-.678 1.367-1.932 2.637-3.023C4.33 2.992 6.019 2 8 2ZM1.679 7.932a.12.12 0 0 0 0 .136c.411.622 1.241 1.75 2.366 2.717C5.176 11.758 6.527 12.5 8 12.5c1.473 0 2.825-.742 3.955-1.715 1.124-.967 1.954-2.096 2.366-2.717a.12.12 0 0 0 0-.136c-.412-.621-1.242-1.75-2.366-2.717C10.824 4.242 9.473 3.5 8 3.5c-1.473 0-2.825.742-3.955 1.715-1.124.967-1.954 2.096-2.366 2.717ZM8 10a2 2 0 1 1-.001-3.999A2 2 0 0 1 8 10Z">
                              </path>
                              <% } else { %>
                                <path
                                  d="M.143 2.31a.75.75 0 0 1 1.047-.167l14.5 10.5a.75.75 0 1 1-.88 1.214l-2.248-1.628C11.346 13.19 9.792 14 8 14c-1.981 0-3.67-.992-4.933-2.078C1.797 10.83.88 9.576.43 8.898a1.62 1.62 0 0 1 0-1.797c.353-.533 1.043-1.503 1.999-2.478L.31 3.357a.75.75 0 0 1-.167-1.047Zm6.066 4.391a2 2 0 0 0 2.887 2.7l-2.887-2.7Zm7.23 5.24-1.523-1.102c.552-.482 1.043-1.007 1.448-1.485a.12.12 0 0 0 0-.136 10.847 10.847 0 0 0-1.9-2.181c-.959-.843-2.11-1.537-3.464-1.537-1.353 0-2.505.694-3.464 1.537-.36.316-.694.657-.999 1.004L2.68 6.078c.978-.988 1.709-1.976 2.083-2.56C6.018 2.494 7.039 2 8 2c1.981 0 3.67.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.377.567-1.083 1.487-2.031 2.442Z">
                                </path>
                                <% } %>
                          </svg>
                          <%= k.is_public ? 'Public' : 'Private' %>
                        </button>
                        <button type="button" class="unbind-btn" data-key="<%= k.api_key %>">Unbind</button>
                      </div>
                    </div>

                    <!-- Key Statistics -->
                    <div class="key-stats">
                      <div class="usage-layout">
                        <div class="usage-left">
                          <% if (k.usage) { %>
                            <div class="usage-card">
                              <div class="usage-row">
                                <span style="color: #57606a;">Plan</span>
                                <span
                                  class="tag <%= k.usage.membership_type === 'pro' ? 'pro' : (k.usage.membership_type === 'business' ? 'business' : '') %>">
                                  <%= k.usage.membership_type || 'Free' %>
                                </span>
                              </div>
                              <div class="usage-row">
                                <span style="color: #57606a;">Expires</span>
                                <span>
                                  <%= helpers.fmtExpire(k.usage.expire_time) %>
                                </span>
                              </div>

                              <% if (k.is_cursor && k.usage.api_limit> 0) { %>
                                <!-- Cursor: 显示 API 使用进度 -->
                                <div class="usage-row">
                                  <span style="color: #57606a;">API Usage</span>
                                  <span>
                                    <%= helpers.dollars(k.usage.api_spend) %> / <%= helpers.dollars(k.usage.api_limit)
                                        %>
                                  </span>
                                </div>
                                <% const apiPct=k.usage.api_limit> 0 ? Math.min(100, Math.round((k.usage.api_spend /
                                  k.usage.api_limit) * 100)) : 0; %>
                                  <% const apiProgressClass=apiPct>= 90 ? 'danger' : (apiPct >= 70 ? 'warning' : ''); %>
                                    <div class="progress <%= apiProgressClass %>">
                                      <div class="bar" style="--w: <%= apiPct %>%"></div>
                                    </div>
                                    <div style="margin-top: 4px; font-size: 12px; color: #57606a; text-align: right;">
                                      <%= apiPct %>% API used
                                    </div>

                                    <% if (k.usage.auto_limit> 0) { %>
                                      <!-- Cursor: Auto 使用进度 -->
                                      <div class="auto-usage-section"
                                        style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #d0d7de;">
                                        <div class="usage-row">
                                          <span style="color: #57606a;">Auto Usage</span>
                                          <span>
                                            <%= helpers.dollars(k.usage.auto_spend) %> / <%=
                                                helpers.dollars(k.usage.auto_limit) %>
                                          </span>
                                        </div>
                                        <% const autoPct=k.usage.auto_limit> 0 ? Math.min(100,
                                          Math.round((k.usage.auto_spend / k.usage.auto_limit) * 100)) : 0; %>
                                          <% const autoProgressClass=autoPct>= 90 ? 'danger' : (autoPct >= 70 ?
                                            'warning' : ''); %>
                                            <div class="progress <%= autoProgressClass %>">
                                              <div class="bar" style="--w: <%= autoPct %>%"></div>
                                            </div>
                                            <div
                                              style="margin-top: 4px; font-size: 12px; color: #57606a; text-align: right;">
                                              <%= autoPct %>% Auto used
                                            </div>
                                      </div>
                                      <% } %>
                                        <% } else if (k.is_trae) { %>
                                          <!-- Trae：显示总体使用量 -->
                                          <div class="usage-row">
                                            <span style="color: #57606a;">Total</span>
                                            <span>
                                              <%= k.usage.total_usage || 0 %>
                                            </span>
                                          </div>
                                          <div class="usage-row">
                                            <span style="color: #57606a;">Used</span>
                                            <span>
                                              <%= k.usage.used_usage || 0 %>
                                            </span>
                                          </div>
                                          <% const remaining = (k.usage.total_usage || 0) - (k.usage.used_usage || 0); %>
                                          <div class="usage-row">
                                            <span style="color: #57606a;">Remaining</span>
                                            <span class="strong">
                                              <%= remaining %>
                                            </span>
                                          </div>
                                          <% const pct = k.usage.total_usage > 0 ? Math.min(100,
                                            Math.round((k.usage.used_usage / k.usage.total_usage) * 100)) : 0; %>
                                          <% const progressClass = pct >= 90 ? 'danger' : (pct >= 70 ? 'warning' : ''); %>
                                          <div class="progress <%= progressClass %>">
                                            <div class="bar" style="--w: <%= pct %>%"></div>
                                          </div>
                                          <div
                                            style="margin-top: 8px; font-size: 12px; color: #57606a; text-align: right;">
                                            <%= pct %>% used
                                          </div>
                                        <% } %>
                            </div>
                            <% } else { %>
                              <div class="usage-card">
                                <div class="empty-state" style="padding: 24px;">
                                  <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor"
                                    stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                                  </svg>
                                  <p style="margin-top: 8px; font-size: 13px;">No usage data yet</p>
                                </div>
                              </div>
                              <% } %>
                        </div>
                        <div class="usage-right">
                          <div class="usage-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                              <div style="font-size: 12px; color: #57606a;" class="trend-title" data-key="<%= k.api_key %>">Usage Trend (30 days)</div>
                              <div class="granularity-selector" data-key="<%= k.api_key %>">
                                <button type="button" class="granularity-btn active" data-granularity="day" data-key="<%= k.api_key %>">Day</button>
                                <button type="button" class="granularity-btn" data-granularity="hour" data-key="<%= k.api_key %>">Hour</button>
                                <button type="button" class="granularity-btn" data-granularity="minute" data-key="<%= k.api_key %>">Min</button>
                              </div>
                            </div>
                            <div class="trend-chart-container" data-key="<%= k.api_key %>" data-is-trae="<%= k.is_trae %>">
                            <% if (k.trend && k.trend.length) { %>
                              <% const W=480, H=160, P=24; const max=k.maxVal || 1; const stepX=(W - P*2) /
                                (k.trend.length - 1); function y(v){ return H - P - (v/max)*(H - P*2); } %>
                                <svg width="100%" height="<%= H %>" viewBox="0 0 <%= W %> <%= H %>" class="chart"
                                  preserveAspectRatio="xMidYMid meet">
                                  <!-- Grid lines -->
                                  <line x1="<%= P %>" y1="<%= P %>" x2="<%= P %>" y2="<%= H - P %>" stroke="#eaeef2"
                                    stroke-width="1" />
                                  <line x1="<%= P %>" y1="<%= H - P %>" x2="<%= W - P %>" y2="<%= H - P %>"
                                    stroke="#eaeef2" stroke-width="1" />

                                  <!-- Area fill -->
                                  <path fill="rgba(9, 105, 218, 0.1)" d="
                            M <%= P %>,<%= H - P %>
                            <% for(let i=0;i<k.trend.length;i++){ %>
                              L <%= (P + i*stepX).toFixed(1) %>,<%= y(k.trend[i].value).toFixed(1) %>
                            <% } %>
                            L <%= (P + (k.trend.length-1)*stepX).toFixed(1) %>,<%= H - P %>
                            Z
                          " />

                                  <!-- Line -->
                                  <polyline fill="none" stroke="#0969da" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" points="
                            <% for(let i=0;i<k.trend.length;i++){ %>
                              <%= (P + i*stepX).toFixed(1) %>,<%= y(k.trend[i].value).toFixed(1) %>
                            <% } %>
                          " />

                                  <!-- Data points -->
                                  <% for(let i=0;i<k.trend.length;i++){ %>
                                    <circle cx="<%= (P + i*stepX).toFixed(1) %>"
                                      cy="<%= y(k.trend[i].value).toFixed(1) %>" r="2" fill="#0969da" />
                                    <% } %>

                                      <!-- X-axis labels -->
                                      <% for(let i=0;i<k.trend.length;i+=Math.ceil(k.trend.length/6)){ %>
                                        <text x="<%= (P + i*stepX).toFixed(1) %>" y="<%= H - 6 %>" font-size="9"
                                          fill="#57606a" text-anchor="middle">
                                          <%= k.trend[i].label %>
                                        </text>
                                        <% } %>
                                </svg>
                                <% } else { %>
                                  <div class="empty-state" style="padding: 24px;">
                                    <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="#d0d7de"
                                      stroke-width="1.5">
                                      <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" />
                                    </svg>
                                    <p style="margin-top: 8px; font-size: 13px; color: #57606a;">No trend data</p>
                                  </div>
                                  <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% } %>
                    <% }) %>
          </div>
          <% } %>
  </div>

  <%- include('partials/bind-modal') %>

    <script>
      // 设置全局 BASE_PATH 变量供 JS 模块使用
      window.BASE_PATH = '<%= basePath %>';
    </script>
    <script src="<%= basePath %>/static/api-manager.js"></script>
    <script src="<%= basePath %>/static/bind-modal.js"></script>
    <script src="<%= basePath %>/static/me.js"></script>
</body>

</html>